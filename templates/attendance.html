{% extends "index.html" %}
{% block content %}
<h2>Attendance</h2>

<div id="attendance-subject">
    {% if course_name %}
    <p>Attendance for <strong>{{ course_name }}</strong></p>
    {% else %}
    <p>Attendance for <strong>Please select a period</strong></p>
    {% endif %}
</div>

<form id="attendance-form">
  <label for="period_id">Select Period:</label>
  <select id="period_id" name="period_id" required>
    {% for period in periods %}
    <option value="{{ period[0] }}" {% if period[0] == selected_period_id %}selected{% endif %}>
      {{ period[1] }} - {{ period[2] }} {{ period[3] }}
    </option>
    {% endfor %}
  </select>
  <button type="button" id="trigger-attendance">Trigger Attendance</button>
  <button type="button" id="view-attendance">View Attendance</button>
</form>

<div id="attendance-records">
    {% if course_name %}
    <h3>Attendance Record For {{ course_name }}</h3>
    {% endif %}
  <table id="attendance-table" style="display: {% if not course_name %}none{% endif %};">
    <tr>
      <th>First Name</th>
      <th>Middle Name</th>
      <th>Last Name</th>
      <th>Roll No</th>
      <th>Status</th>
      <th>Timestamp</th>
    </tr>
    {% if records %}
    {% for record in records %}
    <tr>
      <td>{{ record[0] }}</td>
      <td>{{ record[1] if record[1] else '' }}</td>
      <td>{{ record[2] }}</td>
      <td>{{ record[3] }}</td>
      <td>{{ record[4] }}</td>
      <td>{{ record[5] }}</td>
    </tr>
    {% endfor %}
    {% endif %}
  </table>
  <div id="message"></div>
</div>

<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('#trigger-attendance').on('click', function() {
        var period_id = $('#period_id').val();
        if (!period_id) {
            $('#message').text('Please select a period.').addClass('error');
            return;
        }

        $('#message').text('Starting attendance marking...').removeClass('error');
        $.ajax({
            url: '/mark_attendance/' + period_id,
            type: 'POST',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'success') {
                    $('#message').text(data.message + ' ' + data.absent_message + ' Recognized: ' + data.recognized_count).removeClass('error');
                    $('#view-attendance').click();
                } else {
                    $('#message').text(data.message).addClass('error');
                }
            },
            error: function(xhr, status, error) {
                $('#message').text('Error triggering attendance: ' + error).addClass('error');
                console.log('Error:', error);
            }
        });
    });

    $('#view-attendance').on('click', function() {
        var period_id = $('#period_id').val();
        if (!period_id) {
            $('#message').text('Please select a period.').addClass('error');
            return;
        }

        $.ajax({
            url: '/get_attendance/' + period_id,
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                $('#attendance-table').empty();
                if (data.records.length > 0) {
                    $('#attendance-records h3').text('Attendance Record For ' + data.course_name);
                    $('#attendance-table').show();
                    var headerRow = '<tr><th>First Name</th><th>Middle Name</th><th>Last Name</th><th>Roll No</th><th>Status</th><th>Timestamp</th></tr>';
                    $('#attendance-table').append(headerRow);
                    $.each(data.records, function(index, record) {
                        var row = '<tr>' +
                            '<td>' + record.first_name + '</td>' +
                            '<td>' + record.middle_name + '</td>' +
                            '<td>' + record.last_name + '</td>' +
                            '<td>' + record.roll_no + '</td>' +
                            '<td>' + record.status + '</td>' +
                            '<td>' + record.timestamp + '</td>' +
                            '</tr>';
                        $('#attendance-table').append(row);
                    });
                    $('#message').text('').removeClass('error');
                } else {
                    $('#attendance-records h3').text('Attendance Record For ' + data.course_name);
                    $('#attendance-table').hide();
                    $('#message').text('No attendance records found.').removeClass('error');
                }
                $('#attendance-subject p').html('Attendance for <strong>' + data.course_name + '</strong>');
            },
            error: function(xhr, status, error) {
                $('#message').text('Error fetching attendance: ' + error).addClass('error');
                console.log('Error:', error);
            }
        });
    });

    $('#period_id').on('change', function() {
        var period_id = $(this).val();
        if (period_id) {
            $.ajax({
                url: '/get_attendance/' + period_id,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    $('#attendance-subject p').html('Attendance for <strong>' + data.course_name + '</strong>');
                },
                error: function(xhr, status, error) {
                    $('#attendance-subject p').html('Attendance for <strong>Error fetching subject</strong>');
                    console.log('Error:', error);
                }
            });
        }
    });
});
</script>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}
{% endblock %}