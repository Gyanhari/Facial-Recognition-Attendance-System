{% extends "admin/layout.html" %}
{% block title %}Manage Periods{% endblock %}
{% block content %}
<h2>Manage Periods</h2>

<h3>Add Period</h3>
<form method="POST" id="addPeriodForm">
    <input type="hidden" name="action" value="add">
    <label>Semester: 
        <select name="semester" id="semesterSelect" required onchange="filterCourses()">
            <option value="">Select Semester</option>
            {% for sem in range(1, 9) %}
                <option value="{{ sem }}">{{ sem }}</option>
            {% endfor %}
        </select>
    </label><br>
    <label>Course: 
        <select name="course_id" id="courseSelect" required disabled>
            <option value="">Select Semester First</option>
        </select>
    </label><br>
    <label>Date: <input type="date" name="period_date" required disabled></label><br>
    <label>Start Time: <input type="time" name="start_time" required disabled></label><br>
    <label>Duration (minutes): <input type="number" name="duration" min="45" max="120" required disabled></label><br>
    <button type="submit" id="addPeriodButton" disabled>Add Period</button>
</form>

<h3>Existing Periods</h3>
<div>
    <label for="date_filter">Filter by Date:</label>
    <input type="date" id="date_filter" name="date_filter" onchange="filterPeriods()">
</div>
{% if periods %}
<table id="periods_table">
    <thead>
        <tr>
            <th>S.N.</th>
            <th>Course Name</th>
            <th>Semester</th>
            <th>Date</th>
            <th>Start Time</th>
            <th>Duration (minutes)</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for period in periods %}
        <tr data-date="{{ period[2] }}">
            <td>{{ loop.index }}</td>
            <td>{{ period[1] }}</td>
            <td>{{ period[5] }}</td>
            <td>{{ period[2] }}</td>
            <td>{{ period[3] }}</td>
            <td>{{ period[4] }}</td>
            <td>
                <form method="POST" style="display:inline;">
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="period_id" value="{{ period[0] }}">
                    <label>Course: 
                        <select name="course_id" required>
                            {% for course in courses %}
                                <option value="{{ course[0] }}" {% if course[1] == period[1] %}selected{% endif %}>
                                    {{ course[1] }} (Semester {{ course[3] }})
                                </option>
                            {% endfor %}
                        </select>
                    </label><br>
                    <label>Date: <input type="date" name="period_date" value="{{ period[2] }}" required></label><br>
                    <label>Start Time: <input type="time" name="start_time" value="{{ period[3] }}" required></label><br>
                    <label>Duration: <input type="number" name="duration" value="{{ period[4] }}" min="45" max="120" required></label><br>
                    <button type="submit">Update</button>
                </form>
                <form method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this period?');">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="period_id" value="{{ period[0] }}">
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No periods available.</p>
{% endif %}

<script>
    // Store courses data as a JavaScript object for filtering
    const courses = {
        {% for course in courses %}
            {{ course[3] }}: [
                {"id": "{{ course[0] }}", "name": "{{ course[1] }} (Semester {{ course[3] }})"}
            ]{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    function filterCourses() {
        const semesterSelect = document.getElementById('semesterSelect');
        const courseSelect = document.getElementById('courseSelect');
        const selectedSemester = semesterSelect.value;
        const dateInput = document.querySelector('input[name="period_date"]');
        const timeInput = document.querySelector('input[name="start_time"]');
        const durationInput = document.querySelector('input[name="duration"]');
        const addPeriodButton = document.getElementById('addPeriodButton');

        // Clear current options
        courseSelect.innerHTML = '<option value="">Select Course</option>';

        // Enable/disable form fields based on semester selection
        if (selectedSemester) {
            courseSelect.disabled = false;
            dateInput.disabled = false;
            timeInput.disabled = false;
            durationInput.disabled = false;
            addPeriodButton.disabled = false;

            // Filter and populate courses for the selected semester
            if (courses[selectedSemester]) {
                courses[selectedSemester].forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.name;
                    courseSelect.appendChild(option);
                });
            }
        } else {
            courseSelect.disabled = true;
            dateInput.disabled = true;
            timeInput.disabled = true;
            durationInput.disabled = true;
            addPeriodButton.disabled = true;
        }
    }

    function filterPeriods() {
        const selectedDate = document.getElementById("date_filter").value;
        const rows = document.querySelectorAll("#periods_table tbody tr");

        rows.forEach(row => {
            const rowDate = row.getAttribute("data-date");
            if (!selectedDate || rowDate === selectedDate) {
                row.style.display = ""; // Show row
            } else {
                row.style.display = "none"; // Hide row
            }
        });
    }

    // Initialize filter on page load
    filterPeriods();
    // Initial call to filter courses (in case a semester is pre-selected)
    filterCourses();
</script>
{% endblock %}